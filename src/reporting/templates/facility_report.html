<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workforce Model Utilization - {{ facility_name }}</title>
    <style>
        /* Professional styling for PDF reports */
        
        .header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 12px;
            margin-bottom: 8px;
        }
        
        .header h1 {
            color: black;
            font-size: 22px;
            margin: 0;
            font-weight: bold;
        }
        
        .header .subtitle {
            color: black;
            font-size: 20px;
            margin: 8px 0;
            font-weight: bold;
        }
        
        .header .analysis-info {
            color: #666;
            font-size: 13px;
            margin: 6px 0 3px 0;
            font-weight: normal;
        }
        
        .header .generation-info {
            color: #666;
            font-size: 11px;
            margin: 3px 0 0 0;
            font-weight: normal;
        }
        
        .report-date {
            color: black;
            font-size: 16px;
            margin: 5px 0;
        }
        
        .section {
            margin: 30px 0;
        }
        
        /* Eliminate top margin for first section after header */
        .section:first-of-type {
            margin-top: 0;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 20px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 8px;
            margin: 10px 0;
            max-width: 100%;
        }
        
        /* Ensure optimal layout for 3-4 card sections */
        .kpi-group .kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
        
        /* 2x2 grid layout for specific sections */
        .kpi-grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr !important;
            grid-template-rows: auto auto;
            max-width: 600px;
            gap: 8px;
        }
        
        /* Shorter KPI cards with reduced padding */
        .kpi-card-compact {
            padding: 8px;
            min-height: 45px;
        }
        
        .kpi-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .kpi-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }
        
        .kpi-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-card.variance {
            border-left: 4px solid #e74c3c;
        }
        
        .kpi-card.hours {
            border-left: 4px solid #3498db;
        }
        
        .kpi-card.exceptions {
            border-left: 4px solid #f39c12;
        }
        
        .kpi-card.roles {
            border-left: 4px solid #27ae60;
        }
        
        /* Charts */
        .chart-container {
            text-align: center;
            margin: 20px 0;
            page-break-inside: avoid;
        }
        
        .chart-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        
        .data-table th {
            background-color: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .data-table tr:hover {
            background-color: #e3f2fd;
        }
        
        /* Exception severity styling */
        .severity-high {
            background-color: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .severity-medium {
            background-color: #fff3e0 !important;
            color: #ef6c00;
        }
        
        .severity-low {
            background-color: #f1f8e9 !important;
            color: #2e7d32;
        }
        
        /* Summary boxes */
        .summary-box {
            background: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-box h4 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        /* Page breaks for PDF */
        .page-break {
            page-break-before: always;
        }
        
        .no-break {
            page-break-inside: avoid;
        }
        
        
        /* Body styling */
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.4;
            color: #333;
            max-width: 1350px; /* Increased to accommodate wider variance table container */
            margin: 0 auto;
            padding: 10px; /* Reduced padding for tighter layout */
            background: white;
        }
        
        /* Group boxes for KPIs */
        .kpi-group {
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 12px;
            margin: 12px 0;
            background: #f8f9fa;
            width: 100%;
            max-width: 1300px; /* Increased from default to give more space for variance table */
            box-sizing: border-box;
        }
        
        .kpi-group h3 {
            color: black;
            font-size: 16px;
            margin: 0 0 8px 0;
            text-align: center;
            font-weight: bold;
        }

        /* Exception management table */
        .exception-management-table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            margin: 20px auto;
            font-size: 11px;
            background: white;
            table-layout: fixed;
            box-sizing: border-box;
        }
        
        .exception-management-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            padding: 8px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 10px;
            border: 1px solid #bdc3c7;
        }
        
        .exception-management-table td {
            padding: 2px 8px;
            border: 1px solid #bdc3c7;
            text-align: center;
            vertical-align: middle;
            min-height: 30px;
            height: 30px;
        }
        
        .exception-management-table tr:nth-child(even) {
            background-color: #e9ecef;
        }
        
        /* Prevent table rows from breaking across pages */
        .exception-management-table tr {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .exception-management-table .role-cell {
            text-align: left;
            font-weight: bold;
            background-color: #2c3e50;
            color: white;
            max-width: 120px;
            word-wrap: break-word;
        }
        
        .exception-management-table .total-cell {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        
        /* Variance indicators - background colors removed, using alternating row shading instead */
        
        /* Day headers */
        .day-header {
            background-color: #34495e;
            color: white;
            font-size: 9px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            width: 25px;
            min-width: 25px;
            max-width: 25px;
        }
        
        /* Print-specific styles */
        @media print {
            body { margin: 0; }
            .header { page-break-after: avoid; }
            .chart-container { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <!-- F-6a: Cover page with date range -->
    <div class="header">
        <h1>{{ facility_name }} - Workforce Model Utilization</h1>
        <div class="analysis-info" style="font-size: 16px;">Analysis Period: {{ analysis_start_date }} to {{ analysis_end_date }}</div>
        <div class="generation-info">Generated: {{ generation_date }}</div>
    </div>

    <!-- F-6b: KPI summary groups -->
    <div class="section">
        <!-- Group 1: Facility Model Adherence -->
        {% if show_facility_model_adherence %}
        <div class="kpi-group">
            <h3>Facility Model Adherence</h3>
            <div class="kpi-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div style="border-left: 4px solid #3498db; background: white !important; background-color: white !important; border: 1px solid #ddd; border-radius: 8px; padding: 7.5px 15px; text-align: center; box-shadow: none !important; min-width: 0; overflow: hidden;">
                    <span style="font-size: min(22px, 4vw); font-weight: bold; color: #2c3e50; display: block; margin-bottom: 2.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ kpis.total_model_hours|round(0)|int }}</span>
                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;">Model</div>
                </div>
                <div style="border-left: 4px solid #3498db; background: white !important; background-color: white !important; border: 1px solid #ddd; border-radius: 8px; padding: 7.5px 15px; text-align: center; box-shadow: none !important; min-width: 0; overflow: hidden;">
                    <span style="font-size: min(22px, 4vw); font-weight: bold; color: #2c3e50; display: block; margin-bottom: 2.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ kpis.total_actual_hours|round(0)|int }}</span>
                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;">Actual</div>
                </div>
                <div style="border-left: 4px solid #3498db; background: white !important; background-color: white !important; border: 1px solid #ddd; border-radius: 8px; padding: 7.5px 15px; text-align: center; box-shadow: none !important; min-width: 0; overflow: hidden;">
                    <span style="font-size: min(22px, 4vw); font-weight: bold; color: #2c3e50; display: block; margin-bottom: 2.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{% if kpis.variance_percentage < 0 %}- {{ "%.2f"|format(-kpis.variance_percentage) }}%{% else %}+ {{ "%.2f"|format(kpis.variance_percentage) }}%{% endif %}</span>
                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;">Variance</div>
                </div>
                <div style="border-left: 4px solid #3498db; background: white !important; background-color: white !important; border: 1px solid #ddd; border-radius: 8px; padding: 7.5px 15px; text-align: center; box-shadow: none !important; min-width: 0; overflow: hidden;">
                    <span style="font-size: min(22px, 4vw); font-weight: bold; color: #2c3e50; display: block; margin-bottom: 2.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ "%.2f"|format(100 - kpis.exception_rate) }}%</span>
                    <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;">Compliance</div>
                </div>
            </div>
        </div>
        {% endif %}


        <!-- Variance By Day of Week -->
        {% if show_variance_by_day and exceptions_list %}
        <div class="kpi-group">
            <h3>Variance By Day of Week</h3>
            <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">
                Total actual hours and variance percentages by role and day of week (summed across analysis period)<br>
                Red indicates any variance from model, âœ“ indicates compliance, ðŸ›‘ indicates data configuration issues
            </p>
            
            {{ exception_management_table|safe }}
        </div>
        {% endif %}


        <!-- Top N {{ display_unmapped_term_title }} Hours Section -->
        {% if show_top_unmapped and (top_unmapped_analysis.clinical_group or top_unmapped_analysis.non_clinical_group or top_unmapped_analysis.top_employees) %}
        <div class="kpi-group">
            <h3 style="margin-bottom: 4px;">Top {{ top_unmapped_analysis.top_count_requested }} {{ display_unmapped_term_title }} Hours</h3>
            
            <!-- Clinical Associates Group -->
            {% if top_unmapped_analysis.clinical_group %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    {{ top_unmapped_analysis.clinical_group.display_name }}
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ "%.2f"|format(top_unmapped_analysis.clinical_group.total_unmapped_hours) }} hours, {{ top_unmapped_analysis.clinical_group.total_employees_in_function }} employees with {{ display_unmapped_term }} hours)
                    </span>
                </h4>
                
                {% if top_unmapped_analysis.clinical_group.employees %}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in top_unmapped_analysis.clinical_group.employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.role|replace("Unmapped", display_unmapped_term_title) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_unmapped_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_unmapped }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic; margin-bottom: 10px;">No clinical employees found with {{ display_unmapped_term }} hours for the analysis period.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Non-Clinical Associates Group -->
            {% if top_unmapped_analysis.non_clinical_group %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    {{ top_unmapped_analysis.non_clinical_group.display_name }}
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ "%.2f"|format(top_unmapped_analysis.non_clinical_group.total_unmapped_hours) }} hours, {{ top_unmapped_analysis.non_clinical_group.total_employees_in_function }} employees with {{ display_unmapped_term }} hours)
                    </span>
                </h4>
                
                {% if top_unmapped_analysis.non_clinical_group.employees %}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in top_unmapped_analysis.non_clinical_group.employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.role|replace("Unmapped", display_unmapped_term_title) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_unmapped_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_unmapped }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic; margin-bottom: 10px;">No non-clinical employees found with {{ display_unmapped_term }} hours for the analysis period.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Fallback: Show ungrouped data if no function groups are available -->
            {% if not top_unmapped_analysis.clinical_group and not top_unmapped_analysis.non_clinical_group and top_unmapped_analysis.top_employees %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    Top {{ display_unmapped_term_title }} Associates
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        (Function grouping unavailable)
                    </span>
                </h4>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in top_unmapped_analysis.top_employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.role|replace("Unmapped", display_unmapped_term_title) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_unmapped_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_unmapped }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
        </div>
        {% elif show_top_unmapped %}
        <div class="kpi-group">
            <h3>Top {{ top_unmapped_analysis.top_count_requested }} {{ display_unmapped_term_title }} Hours</h3>
            <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px; color: #27ae60;">
                <span style="font-size: 24px;">âœ…</span><br>
                <strong>Excellent!</strong> No {{ display_unmapped_term }} hours found during this period.
            </div>
        </div>
        {% endif %}

        <!-- Top N Overtime Employees Section -->
        {% if show_top_overtime and overtime_analysis %}
        <div class="kpi-group">
            <h3 style="margin-bottom: 4px;">Top {{ top_overtime_count }} Overtime Employees</h3>
            
            <!-- Summary Statistics -->
            <div style="margin-bottom: 10px; padding: 6px; background-color: #f8f9fa; border-radius: 5px;">
                <div style="display: flex; justify-content: space-around; font-weight: bold; font-size: 14px;">
                    <div>Total Overtime Hours: <span style="color: #e74c3c;">{{ "%.2f"|format(overtime_analysis.total_overtime_hours) }}</span></div>
                    <div>Employees with Overtime: <span style="color: #e74c3c;">{{ overtime_analysis.employee_count }}</span></div>
                </div>
            </div>
            
            {% if overtime_analysis.top_employees %}
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                <thead>
                    <tr style="background-color: #34495e; color: white;">
                        <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                        <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Primary Role</th>
                        <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Total Hours</th>
                        <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">OT Hours</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in overtime_analysis.top_employees %}
                    <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                        <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.name }}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.primary_role }}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ "%.2f"|format(employee.total_hours) }}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.overtime_hours) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #666; font-style: italic; margin-bottom: 10px;">No employees found with overtime for the analysis period.</p>
            {% endif %}
        </div>
        {% elif show_top_overtime %}
        <div class="kpi-group">
            <h3>Top {{ top_overtime_count }} Overtime Employees</h3>
            <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px; color: #27ae60;">
                <span style="font-size: 24px;">âœ…</span><br>
                <strong>Excellent!</strong> No employees worked overtime during this period.
            </div>
        </div>
        {% endif %}

        <!-- Page break before variance roles -->
        <div style="page-break-before: always;"></div>

        <!-- Top N Variance Roles Section -->
        {% if show_top_variance_roles and variance_roles_data and (variance_roles_data.clinical_roles or variance_roles_data.non_clinical_roles) %}
        <div class="kpi-group">
            <h3 style="margin-bottom: 4px;">Top {{ top_variance_roles_count }} Variance Roles</h3>
            
            {% if variance_roles_data.clinical_roles %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    Clinical Roles
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ variance_roles_data.clinical_roles|length }} clinical roles with variances)
                    </span>
                </h4>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 10%;">Rank</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 50%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 20%;">Variance Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 20%;">Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in variance_roles_data.clinical_roles[:top_variance_roles_count] %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #2c3e50;">{{ loop.index }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ role.split('|')[0] }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">
                                {% if role.split('|')[1].startswith('-') %}
                                    - {{ role.split('|')[1][1:] }}
                                {% else %}
                                    {{ role.split('|')[1] }}
                                {% endif %}
                            </td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #000;">
                                {% if role.split('|')[1].startswith('+') %}
                                    Above Model
                                {% else %}
                                    Below Model
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- Fill empty slots if less than configured count clinical roles -->
                        {% for i in range(variance_roles_data.clinical_roles[:top_variance_roles_count]|length, top_variance_roles_count) %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #2c3e50;">{{ i + 1 }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; color: #27ae60; font-style: italic;">No significant variance</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #e74c3c;">-</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #000;">âœ“</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
            <!-- Non-Clinical Roles Group -->
            {% if variance_roles_data.non_clinical_roles %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    Non-Clinical Roles
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ variance_roles_data.non_clinical_roles|length }} non-clinical roles with variances)
                    </span>
                </h4>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 10%;">Rank</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 50%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 20%;">Variance Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 20%;">Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in variance_roles_data.non_clinical_roles[:top_variance_roles_count] %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #2c3e50;">{{ loop.index }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ role.split('|')[0] }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">
                                {% if role.split('|')[1].startswith('-') %}
                                    - {{ role.split('|')[1][1:] }}
                                {% else %}
                                    {{ role.split('|')[1] }}
                                {% endif %}
                            </td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #000;">
                                {% if role.split('|')[1].startswith('+') %}
                                    Above Model
                                {% else %}
                                    Below Model
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- Fill empty slots if less than configured count non-clinical roles -->
                        {% for i in range(variance_roles_data.non_clinical_roles[:top_variance_roles_count]|length, top_variance_roles_count) %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #2c3e50;">{{ i + 1 }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; color: #27ae60; font-style: italic;">No significant variance</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #e74c3c;">-</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; color: #000;">âœ“</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        {% elif show_top_variance_roles %}
        <div class="kpi-group">
            <h3>Top {{ top_variance_roles_count }} Variance Roles</h3>
            <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px; color: #27ae60;">
                <span style="font-size: 24px;">âœ…</span><br>
                <strong>Excellent!</strong> No significant role variances found during this period.
            </div>
        </div>
        {% endif %}

        <!-- Top N Variance Employees Section -->
        {% if show_top_variance_employees and (variance_employees_analysis.clinical_group or variance_employees_analysis.non_clinical_group or variance_employees_analysis.top_employees) %}
        <div class="kpi-group">
            <h3 style="margin-bottom: 4px;">Top {{ variance_employees_analysis.top_count_requested }} Variance Employees</h3>
            
            <!-- Clinical Associates Group -->
            {% if variance_employees_analysis.clinical_group %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    {{ variance_employees_analysis.clinical_group.display_name }}
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ "%.2f"|format(variance_employees_analysis.clinical_group.total_variance_hours) }} hours, {{ variance_employees_analysis.clinical_group.total_employees_in_function }} employees with variance)
                    </span>
                </h4>
                
                {% if variance_employees_analysis.clinical_group.employees %}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Primary Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in variance_employees_analysis.clinical_group.employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.primary_role }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_variance_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_variance }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic; margin-bottom: 10px;">No clinical employees found with variance for the analysis period.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Non-Clinical Associates Group -->
            {% if variance_employees_analysis.non_clinical_group %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    {{ variance_employees_analysis.non_clinical_group.display_name }}
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ "%.2f"|format(variance_employees_analysis.non_clinical_group.total_variance_hours) }} hours, {{ variance_employees_analysis.non_clinical_group.total_employees_in_function }} employees with variance)
                    </span>
                </h4>
                
                {% if variance_employees_analysis.non_clinical_group.employees %}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Primary Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in variance_employees_analysis.non_clinical_group.employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.primary_role }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_variance_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_variance }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic; margin-bottom: 10px;">No non-clinical employees found with variance for the analysis period.</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Fallback: Show ungrouped data if no function groups are available -->
            {% if not variance_employees_analysis.clinical_group and not variance_employees_analysis.non_clinical_group and variance_employees_analysis.top_employees %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    Top Variance Employees Associates
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        (Function grouping unavailable)
                    </span>
                </h4>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Primary Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Variance Days</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in variance_employees_analysis.top_employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px; font-weight: bold;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.primary_role }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_variance_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ employee.days_with_variance }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
        </div>
        {% elif show_top_variance_employees %}
        <div class="kpi-group">
            <h3>Top {{ top_variance_employees_count }} Variance Employees</h3>
            <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">
                No variance employees found for the analysis period
            </p>
            
            <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px; color: #27ae60;">
                <span style="font-size: 24px;">âœ…</span><br>
                <strong>Excellent!</strong> No employees had variance during this period.
            </div>
        </div>
        {% endif %}


        <!-- Page break before {{ display_unmapped_term }} hours breakdown -->
        <div style="page-break-before: always;"></div>

        <!-- {{ display_unmapped_term_title }} Hours Breakdown -->
        {% if show_unmapped_hours and unmapped_hours.has_unmapped_hours %}
        <div class="kpi-group">
            <h3 style="margin-bottom: 4px;">{{ display_unmapped_term_title }} Hours Breakdown</h3>
            
            <!-- Summary Statistics -->
            <div style="margin-bottom: 0px; padding: 6px; background-color: #f8f9fa; border-radius: 5px;">
                <div style="display: flex; justify-content: space-around; font-weight: bold; font-size: 14px;">
                    <div>Total {{ display_unmapped_term_title }} Hours: <span style="color: #e74c3c;">{{ "%.2f"|format(unmapped_hours.total_unmapped_hours) }}</span></div>
                    <div>Employees: <span style="color: #e74c3c;">{{ unmapped_hours.total_employees }}</span></div>
                </div>
            </div>
            
            <!-- Category Breakdown Tables -->
            {% for category in unmapped_hours.categories %}
            <div style="margin-bottom: 4px;">
                <h4 style="color: #2c3e50; margin-top: 4px; margin-bottom: 4px; padding: 4px; background-color: #ecf0f1; border-left: 4px solid #3498db;">
                    {{ category.display_name }}
                    <span style="font-weight: normal; font-size: 12px; color: #666; margin-left: 10px;">
                        ({{ "%.2f"|format(category.total_hours) }} hours, {{ "%.2f"|format(category.percentage_of_total_unmapped) }}% of total {{ display_unmapped_term }})
                    </span>
                </h4>
                
                {% if category.employees %}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #34495e; color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 40%;">Employee Name</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: left; width: 30%;">Role</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">Hours</th>
                            <th style="border: 1px solid #bdc3c7; padding: 6px; text-align: center; width: 15%;">% of Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in category.employees %}
                        <tr style="{% if loop.index % 2 == 0 %}background-color: #f8f9fa;{% endif %}">
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.employee_name }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px;">{{ employee.category|replace("Unmapped", display_unmapped_term_title) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center; font-weight: bold; color: #e74c3c;">{{ "%.2f"|format(employee.total_hours) }}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 4px; text-align: center;">{{ "%.2f"|format(employee.percentage_of_category) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: #666; font-style: italic; margin-bottom: 10px;">No employees found in this category for the analysis period.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- F-6c: Variance heat-map & trend charts -->
    {% if show_visual_analysis %}
    <div class="section page-break">
        <h2>Visual Analysis</h2>
        
        {% if show_kpi_chart %}
        <h3>Key Performance Indicators</h3>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ kpi_chart }}" alt="KPI Summary Chart">
        </div>
        {% endif %}

        {% if show_variance_heatmap and variance_heatmap %}
        <h3>Variance Heat-map</h3>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ variance_heatmap }}" alt="Variance Heat-map">
        </div>
        {% endif %}

        {% if show_trend_charts and trend_charts %}
        <h3>Trend Analysis</h3>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ trend_charts }}" alt="Trend Analysis Charts">
        </div>
        {% endif %}

        {% if show_control_limits_chart and control_limits_chart %}
        <h3>Statistical Control Limits</h3>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ control_limits_chart }}" alt="Control Limits Chart">
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- F-6d: Detailed exception list -->
    {% if show_exception_details and exceptions_list %}
    <div class="section page-break">
        <h2>Exception Details</h2>
        
        <div class="summary-box">
            <h4>Exception Summary</h4>
            <p><strong>Model Variances:</strong> {{ summary.model_variances }} exceptions</p>
            <p><strong>Statistical Exceptions:</strong> {{ summary.statistical_exceptions }} exceptions</p>
            <p><strong>Trend Exceptions:</strong> {{ summary.trend_exceptions }} exceptions</p>
            <p><strong>Most Problematic Role:</strong> {{ kpis.most_problematic_role or 'N/A' }}</p>
            <p><strong>Average Severity:</strong> {{ "%.2f"|format(summary.severity_score) }}/100</p>
        </div>

        <h3>Detailed Exception List</h3>
        
        {% if exceptions_pagination.showing_summary %}
        <div class="alert alert-info">
            <strong>ðŸ“‹ Large Dataset Notice:</strong> 
            Showing first {{ exceptions_list|length }} of {{ exceptions_pagination.total_exceptions }} exceptions. 
            {{ exceptions_pagination.truncated_count }} additional exceptions are summarized in the statistics above.
            Full dataset would span {{ exceptions_pagination.total_pages }} pages at {{ exceptions_pagination.max_per_page }} exceptions per page.
        </div>
        {% endif %}
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Role</th>
                    <th>Exception Type</th>
                    <th>Severity</th>
                    <th>Description</th>
                    <th>Variance</th>
                    <th>Threshold</th>
                </tr>
            </thead>
            <tbody>
                {% for exception in exceptions_list %}
                <tr class="{% if exception.severity >= 70 %}severity-high{% elif exception.severity >= 40 %}severity-medium{% else %}severity-low{% endif %}">
                    <td>{{ exception.date.strftime('%m/%d/%Y') if exception.date else 'N/A' }}</td>
                    <td>{{ exception.role }}</td>
                    <td>{{ exception.exception_type.title() }}</td>
                    <td>{{ "%.2f"|format(exception.severity) }}</td>
                    <td>{{ exception.description }}</td>
                    <td>
                        {% if exception.variance_percentage %}
                            {{ "%.2f"|format(exception.variance_percentage) }}%
                        {% elif exception.variance_value %}
                            {{ "%.2f"|format(exception.variance_value) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if exception.threshold_used %}
                            {{ "%.2f"|format(exception.threshold_used) }}{% if exception.exception_type == 'model' %}%{% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if exceptions_pagination.showing_summary %}
        <div class="summary-box">
            <h4>Dataset Summary</h4>
            <p><strong>Total Exceptions:</strong> {{ exceptions_pagination.total_exceptions }}</p>
            <p><strong>Displayed:</strong> {{ exceptions_list|length }} ({{ "%.2f"|format((exceptions_list|length / exceptions_pagination.total_exceptions) * 100) }}%)</p>
            <p><strong>Report Optimization:</strong> Large datasets are summarized for optimal PDF performance. Consider filtering by role or time period for detailed analysis.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Statistical Summary -->
    {% if show_statistical_summary and statistics_summary %}
    <div class="section page-break">
        <h2>Statistical Summary</h2>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Role</th>
                    <th>Sample Size</th>
                    <th>Mean Hours</th>
                    <th>Control Method</th>
                    <th>Upper Control Limit</th>
                    <th>Lower Control Limit</th>
                    <th>Normal Distribution</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in statistics_summary %}
                <tr>
                    <td>{{ stat.role }}</td>
                    <td>{{ stat.n_samples }}</td>
                    <td>{{ "%.2f"|format(stat.mean) }}</td>
                    <td>{{ stat.control_method.title() }}</td>
                    <td>{{ "%.2f"|format(stat.upper_control_limit) }}</td>
                    <td>{{ "%.2f"|format(stat.lower_control_limit) }}</td>
                    <td>{{ 'Yes' if stat.is_normal_distribution else 'No' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Consolidated Footnotes Section -->
    {% if show_facility_model_adherence or show_top_variance_roles %}
    <div class="section page-break">
        <h2>Footnotes</h2>
        
        {% if show_facility_model_adherence %}
        <div style="font-size: 11px; color: #666; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-left: 3px solid #3498db; line-height: 1.4;">
            <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 8px;">Facility Model Adherence</h4>
            <strong>Overall Variance:</strong> Calculated as the percentage difference between total actual hours and total model hours across all roles and days in the analysis period. A positive variance indicates actual hours above model, while negative indicates below model relative to the staffing plan.<br><br>
            <strong>Compliance Rate:</strong> Represents the percentage of role-day combinations that operated within acceptable variance thresholds of the workforce model. This is calculated as 100% minus the exception rate, providing a measure of how well the facility adhered to planned staffing levels.
        </div>
        {% endif %}
        
        {% if show_top_variance_roles %}
        <div style="font-size: 11px; color: #666; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-left: 3px solid #3498db; line-height: 1.4;">
            <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 8px;">Top {{ top_variance_roles_count }} Variance Roles</h4>
            <strong>Exception Rate:</strong> Calculated as the percentage of role-day combinations that deviated from the workforce model during the analysis period. This metric represents the frequency of variances across all roles and days, providing an overall measure of adherence to the staffing model.
        </div>
        {% endif %}
    </div>
    {% endif %}

</body>
</html>